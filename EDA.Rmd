---
title: "Untitled"
author: "Wranglers"
date: "Thursday, October 01, 2015"
output: html_document
---

```{r, message=FALSE}
# load libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(knitr)
library(stringr)

# load mined .csv
setwd('~/DSBA-6100/DSBA6100-GrpProject/')
patent_file <- 'medtronic_and_competitor_patents_05-15.csv'
patents <- read.csv(patent_file, stringsAsFactors=FALSE, na.strings="None")

# extract main classification
patents <- mutate(patents, patent_class = str_trim(patent_class)) %>%
    mutate(main_classification = str_sub(patent_class, 1, 3))

# load classification codes
class_code <- read.csv('patent_classification_lookup_table.csv',
                       stringsAsFactors = FALSE,
                       na.strings = "None")
names(class_code) <- c("main_classification", "class_description")

# join patents and classification codes
patents <- left_join(patents, class_code)
```

How many patent classifications were missed?
```{r}
# missed by regular expression
sum(is.na(patents$class_description))

# missed by pulling first three characters
sum(is.na(patents$class_description))
mean(is.na(patents$class_description))
```

```{r}
# define uspto patent counts
med_actual <- c(257, 306, 317, 214 + 18, 286 + 46, 525 + 74, 
                522 + 49, 581 + 117, 668 + 808, 723 + 700, 151 + 216)
stryker_actual <- c(33, 30, 27, 31, 48, 65, 82, 94, 116, 117, 21)
bs_actual <- c(86, 146, 156, 192, 274, 474, 507, 477, 504, 561, 100)
abbott_actual <- c(54, 101, 85, 101, 115, 253, 433, 505, 508, 449, 76)

# count mined patents by company by year
patent_counts <- patents %>% 
    group_by(company_name, year_granted) %>% 
    summarise(mined = n()) 
patent_counts$uspto <- c(abbott_actual, bs_actual, med_actual, stryker_actual)

# compare mined patent counts to reported USPTO patent counts
patent_ratios <- gather(patent_counts, "source_found", "count", 3:4)
# names(patent_ratios)[3:4] <- c("source_found","count")
```

```{r}
# visualize ratios by year
plot_ratios <- ggplot(patent_ratios, aes(company_name, count, fill=source_found)) +
    geom_bar(stat='identity', position='dodge') +
    facet_grid(.~year_granted, scales="free_y") +
    labs(list(title = "Patent Counts: Biblio Data vs USPTO",
              x = "Company Name",
              y = "Number of Patents")) +
    theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5))
plot_ratios
```

```{r}
# visualize ratios: total by company
plot_totals <- ggplot(patent_ratios, aes(company_name, count, fill=source_found)) +
    geom_bar(stat='identity', position='dodge') +
    labs(list(title = "Patent Counts: Biblio Data vs USPTO",
              x = "Company Name",
              y = "Number of Patents")) +
    theme(title = element_text(size = 16))
plot_totals
```

```{r, message=FALSE, warning=FALSE}
library(wordcloud)   # Package for word clouds
library(wesanderson) # color palettes
library(RWeka)       # NLP (n-grams)

# filter company equal to Medtronic
med <- patents %>% filter(company_name == 'Medtronic')

# visualize patent titles
palette <- wes_palette("Darjeeling", 5, "discrete")
palette <- palette[5:1]
wordcloud(med$patent_title, max.words=150, colors=palette)

# visualize patent abstracts
ngrams <- NGramTokenizer(med$patent_abstract)
abstracts <- data.frame(ngram = ngrams) %>%
    group_by(ngram) %>%
    summarise(count = n())

filtered <- filter(abstracts, count < 3000, count > 200)
wordcloud(filtered$ngram, filtered$count, colors=palette)
```

```{r}
# Visualize patent classifications
class_counts <- patents %>%
    group_by(class_description) %>%
    summarise(n = n())
class_counts <- filter(class_counts, 
                       n >= quantile(class_counts$n, .90),
                       is.na(class_description) == FALSE)

# plot all companies
plot_class_all <- ggplot(class_counts, 
                         aes(reorder(class_description, n), n)) + 
    geom_bar(stat="identity", fill="#FD6467") +
    labs(x = "Main Patent Classification") +
    coord_flip() +
    ggtitle("Top 10th Percentile of Patent Classes All Companies")
plot_class_all

# plot by company
class_cts_by_co <- patents %>%
    group_by(company_name, class_description) %>%
    summarise(n = n())
class_cts_by_co <- filter(class_cts_by_co, 
                          n >= quantile(class_cts_by_co$n, .90),
                          is.na(class_description) == FALSE)

plot_class_co <- ggplot(class_cts_by_co,
                        aes(reorder(class_description, n),
                                    n, 
                                    fill = company_name)) +
    geom_bar(stat = "identity", position = "dodge") +
    labs(x = "Main Patent Classification", 
         title="Top 10th Percentile of Patent Classes by Company") +
    coord_flip()
plot_class_co

# plot medtronic only
class_ct_med <- med %>%
    filter(is.na(class_description) == FALSE) %>%
    group_by(class_description) %>%
    summarise(n = n(), proportion = n()/nrow(med))
class_ct_med <- filter(class_ct_med, n >= quantile(class_ct_med$n, .75))

plot_med_class <- ggplot(class_ct_med,
                         aes(reorder(class_description, n), proportion)) +
    geom_bar(stat="identity", fill="#5BBCD6") +
    labs(x = "Main Patent Classification",
         title = "Top Patent Classes for Medtronic") +
    coord_flip()
plot_med_class

# proportions of top n patent classes
sorted_by_prop <- arrange(class_ct_med, desc(proportion)) %>%
    mutate(cumulative_sum = proportion)
for(i in 2:nrow(sorted_by_prop)){
    sorted_by_prop[i,4] <- sum(sorted_by_prop[i, 3], sorted_by_prop[i - 1, 4])
}
# plot
plot_prop <- ggplot(sorted_by_prop, 
                    aes(reorder(class_description, n), cumulative_sum)) +
    geom_bar(stat="identity", fill="#5BBCD6") +
    coord_flip()
plot_prop
```